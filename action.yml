name: "Cached Checkout"
description: "Caches and checks out the repository, downloading a previously cached version if available."
author: pi-xcels
inputs:
  repository:
    description: 'Repository name and owner in the format "owner/repo". Defaults to the current repository.'
    required: false
    default: ${{ github.repository }}
  ref:
    description: "The branch, tag or SHA to checkout. Defaults to the current ref."
    required: false
    default: ${{ github.ref }}
  path:
    description: "Path to checkout the repository into. Defaults to ./checkout."
    required: false
    default: "checkout"
  token:
    description: "Token to use for checkout (e.g., github.token). Required if repository is private."
    required: false
    default: ${{ github.token }}

outputs:
  cache-hit:
    description: "Boolean indicating if the checkout cache was hit."
    value: ${{ steps.restore-cache.outputs.cache-hit }}

runs:
  using: "composite"
  steps:
    - name: Set cache key variables
      id: set-cache-key
      shell: bash
      run: |
        echo "cache_key=${{ runner.os }}-${{ inputs.repository }}-cache-checkout-${{ github.sha }}" >> $GITHUB_OUTPUT
        echo "restore_key=${{ runner.os }}-${{ inputs.repository }}-cache-checkout-" >> $GITHUB_OUTPUT

    - name: Restore checkout cache
      id: restore-cache
      uses: actions/cache@v4
      with:
        path: ${{ inputs.path }}
        key: ${{ steps.set-cache-key.outputs.cache_key }}
        restore-keys: |
          ${{ steps.set-cache-key.outputs.restore_key }}

    # Using custom path to retain checkout across workflow/job triggers
    - name: Checkout code (if cache miss)
      if: steps.restore-cache.outputs.cache-hit != 'true'
      uses: actions/checkout@v4
      with:
        repository: ${{ inputs.repository }}
        ref: ${{ inputs.ref }}
        token: ${{ inputs.token }}
        fetch-depth: 0

    - name: Move contents to root
      shell: bash
      run: |
        echo "Moving contents of ${{ inputs.path }} to ./"
        cp -a "${{ inputs.path }}/." ./
